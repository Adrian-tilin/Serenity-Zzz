<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Foro | Serenity</title>
  <link rel="stylesheet" href="../CSS/Foro/Foro.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="chat-header">
    <a href="Select.html" class="back-btn">‚Üê Volver</a>
    <div class="header-content">
      <img src="../assets/img/Select/Iconos/logo2.0.webp" alt="Serenity Logo" class="header-logo">
      <h1>Foro Serenity</h1>
    </div>
  </header>

  <main class="app-layout">
    <aside class="sidebar-left">
      <div class="server-header">
        <h2>Serenity</h2>
      </div>
      <div class="resources">
        <h3>Recursos</h3>
        <a href="Equipo.html" class="resource-link">
          <img src="../assets/img/Select/Iconos/Equipo.png" alt="Equipo" class="resource-icon"> Equipo
        </a>
        <a href="information.html" class="resource-link">
          <img src="../assets/img/Select/Iconos/informacion.png" alt="Informaci√≥n" class="resource-icon"> Informaci√≥n
        </a>
        <a href="Terminos.html" class="resource-link">
          <img src="../assets/img/Select/Iconos/terminos.png" alt="T√©rminos" class="resource-icon"> T√©rminos de Uso
        </a>
        <a href="Select.html" class="resource-link">
          <img src="../assets/img/Select/Iconos/Minijuegos.png" alt="Minijuegos" class="resource-icon"> Minijuegos
        </a>
      </div>
    </aside>

    <div class="chat-main">
      <div class="chat-messages" id="messages" aria-live="polite" aria-relevant="additions">
        <div style="text-align: center; padding: 20px; color: #888;">
          Cargando mensajes...
        </div>
      </div>

      <form id="composer" class="chat-input" autocomplete="off">
        <input id="message" name="message" maxlength="500" placeholder="Escribe tu mensaje..." required />
        <button type="submit" aria-label="Enviar mensaje">Enviar</button>
      </form>
    </div>

    <aside class="sidebar-right">
      <div class="registered-users">
        <h3>Usuarios Registrados ‚Äî <span id="userCount">0</span></h3>
        <div id="usersList">
          <div style="text-align: center; padding: 20px; color: #888;">
            Cargando usuarios...
          </div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      // Configuraci√≥n de Supabase
      const SUPABASE_URL = 'https://aizxgbigmmwlrrhlhusn.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpenhnYmlnbW13bHJyaGxodXNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MDIxNTEsImV4cCI6MjA3ODE3ODE1MX0.mkdIM7hRMBZ5rEYw6_0dSDM9dmT_IEOhTuUBKjJMm7Y';
      
      // Inicializar Supabase
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      console.log('üöÄ Foro iniciado con Supabase');
      
      const elMessages = document.getElementById('messages');
      const elComposer = document.getElementById('composer');
      const elMessage = document.getElementById('message');
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');

      console.log('üë§ Usuario actual:', user);

      // Verificar autenticaci√≥n
      if (!user || !user.id) {
        alert('Debes iniciar sesi√≥n para usar el foro');
        window.location.href = 'login-register.html';
        return;
      }

      function escapeHtml(s){
        return (s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
      }

      async function loadPosts(){
        try {
          console.log('üì® Cargando posts desde Supabase...');
          
          const { data, error } = await supabase
            .from('posts')
            .select(`
              id,
              message,
              created_at,
              users (
                id,
                username,
                profile_image
              )
            `)
            .order('created_at', { ascending: true });

          if (error) {
            console.error('‚ùå Error cargando posts:', error);
            throw error;
          }

          console.log('‚úÖ Posts cargados:', data?.length || 0);
          return data || [];
        } catch (error) {
          console.error('‚ùå Error loading posts:', error);
          elMessages.innerHTML = `<div style="text-align: center; padding: 20px; color: #f44336;">
            Error al cargar mensajes: ${error.message}
          </div>`;
          return [];
        }
      }

      async function loadUsers(){
        try {
          console.log('üë• Cargando usuarios desde Supabase...');
          
          const { data, error } = await supabase
            .from('users')
            .select('id, username, email, profile_image')
            .order('username', { ascending: true });

          if (error) {
            console.error('‚ùå Error cargando usuarios:', error);
            throw error;
          }

          console.log('‚úÖ Usuarios cargados:', data?.length || 0);
          return data || [];
        } catch (error) {
          console.error('‚ùå Error loading users:', error);
          const usersList = document.getElementById('usersList');
          usersList.innerHTML = `<div style="text-align: center; padding: 10px; color: #f44336; font-size: 12px;">
            Error al cargar usuarios
          </div>`;
          return [];
        }
      }

      function renderUsers(users){
        const usersList = document.getElementById('usersList');
        const userCount = document.getElementById('userCount');
        
        console.log('üé® Renderizando', users.length, 'usuarios');
        
        userCount.textContent = users.length;
        usersList.innerHTML = '';

        if (users.length === 0) {
          usersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No hay usuarios registrados</div>';
          return;
        }

        users.forEach(user => {
          const userEl = document.createElement('div');
          userEl.className = 'user';
          userEl.style.cursor = 'pointer';
          userEl.onclick = () => {
            window.location.href = `Perfil/perfil-publico.html?id=${user.id}`;
          };

          const avatarSrc = user.profile_image || `https://api.dicebear.com/7.x/thumbs/svg?seed=${user.username}&backgroundColor=b6a6f2,ffc6d9&shapeColor=ffffff`;
          userEl.innerHTML = `
            <div class="user-avatar"><img src="${avatarSrc}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"></div>
            <span>${escapeHtml(user.username)}</span>
          `;
          usersList.appendChild(userEl);
        });
      }

      function render(posts){
        console.log('üé® Renderizando', posts.length, 'posts');
        
        elMessages.innerHTML = '';
        
        if (posts.length === 0) {
          elMessages.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No hay mensajes a√∫n. ¬°S√© el primero en escribir!</div>';
          return;
        }

        posts.forEach((post, index) => {
          const msgEl = document.createElement('div');
          msgEl.className = 'message';
          msgEl.style.animationDelay = `${index * 0.05}s`;
          const avatarSrc = post.users?.profile_image || `https://api.dicebear.com/7.x/thumbs/svg?seed=${post.users?.username || 'Usuario'}&backgroundColor=b6a6f2,ffc6d9&shapeColor=ffffff`;
          msgEl.innerHTML = `
            <div class="message-avatar"><img src="${avatarSrc}" alt="Avatar"></div>
            <div class="message-content">
              <div class="message-header">
                <span class="message-author">${escapeHtml(post.users?.username || 'Usuario')}</span>
                <span class="message-time">${new Date(post.created_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
              </div>
              <div class="message-text">${escapeHtml(post.message)}</div>
            </div>
          `;
          elMessages.appendChild(msgEl);
        });
        elMessages.scrollTop = elMessages.scrollHeight;
      }

      async function loadAndRender(){
        console.log('üîÑ Recargando todo...');
        const [posts, users] = await Promise.all([
          loadPosts(),
          loadUsers()
        ]);
        render(posts);
        renderUsers(users);
      }

      elComposer.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = elMessage.value.trim();
        
        console.log('üì§ Intentando enviar mensaje:', text);
        
        if (!text) {
          console.warn('‚ö†Ô∏è Mensaje vac√≠o');
          return;
        }
        
        if (!user || !user.id) {
          console.error('‚ùå No hay usuario');
          alert('No est√°s autenticado. Por favor, inicia sesi√≥n.');
          window.location.href = 'login-register.html';
          return;
        }

        const submitBtn = elComposer.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';

        try {
          console.log('üì§ Insertando post en Supabase...');
          console.log('üì§ User ID:', user.id);
          console.log('üì§ Mensaje:', text);

          const { data, error } = await supabase
            .from('posts')
            .insert([
              { 
                user_id: user.id,
                message: text
              }
            ])
            .select();

          if (error) {
            console.error('‚ùå Error insertando post:', error);
            throw error;
          }

          console.log('‚úÖ Mensaje enviado:', data);
          
          elMessage.value = '';
          await loadAndRender();
          
        } catch (error) {
          console.error('‚ùå Error posting:', error);
          alert('Error al enviar mensaje: ' + error.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });

      // Cargar datos iniciales
      loadAndRender();

      // Auto-refresh cada 5 segundos
      setInterval(loadAndRender, 5000);
      console.log('‚è±Ô∏è Auto-refresh activado (cada 5 segundos)');

      // Suscribirse a cambios en tiempo real
      const postsSubscription = supabase
        .channel('posts_channel')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'posts' }, 
          (payload) => {
            console.log('üîî Cambio detectado en posts:', payload);
            loadAndRender();
          }
        )
        .subscribe();

      console.log('üîî Suscripci√≥n a tiempo real activada');
    })();
  </script>
</body>
</html>